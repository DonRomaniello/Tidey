const harcon = {
  units: "feet",
  HarmonicConstituents: [
    {
      number: 1,
      name: "M2",
      description: "Principal lunar semidiurnal constituent",
      amplitude: 9.13,
      phase_GMT: 105.1,
      phase_local: 320.1,
      speed: 28.984104
    },
    {
      number: 2,
      name: "S2",
      description: "Principal solar semidiurnal constituent",
      amplitude: 1.4,
      phase_GMT: 147.6,
      phase_local: 357.6,
      speed: 30.0
    },
    {
      number: 3,
      name: "N2",
      description: "Larger lunar elliptic semidiurnal constituent",
      amplitude: 1.95,
      phase_GMT: 75.9,
      phase_local: 293.7,
      speed: 28.43973
    },
    {
      number: 4,
      name: "K1",
      description: "Lunar diurnal constituent",
      amplitude: 0.51,
      phase_GMT: 199.7,
      phase_local: 124.4,
      speed: 15.041069
    },
    {
      number: 5,
      name: "M4",
      description: "Shallow water overtides of principal lunar constituent",
      amplitude: 0.27,
      phase_GMT: 111.4,
      phase_local: 181.5,
      speed: 57.96821
    },
    {
      number: 6,
      name: "O1",
      description: "Lunar diurnal constituent",
      amplitude: 0.39,
      phase_GMT: 178.9,
      phase_local: 109.1,
      speed: 13.943035
    },
    {
      number: 7,
      name: "M6",
      description: "Shallow water overtides of principal lunar constituent",
      amplitude: 0.33,
      phase_GMT: 282.0,
      phase_local: 207.2,
      speed: 86.95232
    },
    {
      number: 8,
      name: "MK3",
      description: "Shallow water terdiurnal",
      amplitude: 0.0,
      phase_GMT: 0.0,
      phase_local: 0.0,
      speed: 44.025173
    },
    {
      number: 9,
      name: "S4",
      description: "Shallow water overtides of principal solar constituent",
      amplitude: 0.0,
      phase_GMT: 0.0,
      phase_local: 0.0,
      speed: 60.0
    },
    {
      number: 10,
      name: "MN4",
      description: "Shallow water quarter diurnal constituent",
      amplitude: 0.11,
      phase_GMT: 81.0,
      phase_local: 153.8,
      speed: 57.423832
    },
    {
      number: 11,
      name: "NU2",
      description: "Larger lunar evectional constituent",
      amplitude: 0.44,
      phase_GMT: 85.8,
      phase_local: 303.2,
      speed: 28.512583
    },
    {
      number: 12,
      name: "S6",
      description: "Shallow water overtides of principal solar constituent",
      amplitude: 0.0,
      phase_GMT: 0.0,
      phase_local: 0.0,
      speed: 90.0
    },
    {
      number: 13,
      name: "MU2",
      description: "Variational constituent",
      amplitude: 0.12,
      phase_GMT: 172.8,
      phase_local: 32.9,
      speed: 27.968208
    },
    {
      number: 14,
      name: "2N2",
      description: "Lunar elliptical semidiurnal second-order constituent",
      amplitude: 0.21,
      phase_GMT: 78.3,
      phase_local: 298.8,
      speed: 27.895355
    },
    {
      number: 15,
      name: "OO1",
      description: "Lunar diurnal",
      amplitude: 0.03,
      phase_GMT: 238.9,
      phase_local: 158.2,
      speed: 16.139101
    },
    {
      number: 16,
      name: "LAM2",
      description: "Smaller lunar evectional constituent",
      amplitude: 0.17,
      phase_GMT: 125.8,
      phase_local: 338.5,
      speed: 29.455626
    },
    {
      number: 17,
      name: "S1",
      description: "Solar diurnal constituent",
      amplitude: 0.03,
      phase_GMT: 160.0,
      phase_local: 85.0,
      speed: 15.0
    },
    {
      number: 18,
      name: "M1",
      description: "Smaller lunar elliptic diurnal constituent",
      amplitude: 0.03,
      phase_GMT: 191.6,
      phase_local: 119.1,
      speed: 14.496694
    },
    {
      number: 19,
      name: "J1",
      description: "Smaller lunar elliptic diurnal constituent",
      amplitude: 0.03,
      phase_GMT: 221.1,
      phase_local: 143.1,
      speed: 15.5854435
    },
    {
      number: 20,
      name: "MM",
      description: "Lunar monthly constituent",
      amplitude: 0.0,
      phase_GMT: 0.0,
      phase_local: 0.0,
      speed: 0.5443747
    },
    {
      number: 21,
      name: "SSA",
      description: "Solar semiannual constituent",
      amplitude: 0.05,
      phase_GMT: 127.6,
      phase_local: 127.1,
      speed: 0.0821373
    },
    {
      number: 22,
      name: "SA",
      description: "Solar annual constituent",
      amplitude: 0.0,
      phase_GMT: 0.0,
      phase_local: 0.0,
      speed: 0.0410686
    },
    {
      number: 23,
      name: "MSF",
      description: "Lunisolar synodic fortnightly constituent",
      amplitude: 0.0,
      phase_GMT: 0.0,
      phase_local: 0.0,
      speed: 1.0158958
    },
    {
      number: 24,
      name: "MF",
      description: "Lunisolar fortnightly constituent",
      amplitude: 0.0,
      phase_GMT: 0.0,
      phase_local: 0.0,
      speed: 1.0980331
    },
    {
      number: 25,
      name: "RHO",
      description: "Larger lunar evectional diurnal constituent",
      amplitude: 0.0,
      phase_GMT: 0.0,
      phase_local: 0.0,
      speed: 13.471515
    },
    {
      number: 26,
      name: "Q1",
      description: "Larger lunar elliptic diurnal constituent",
      amplitude: 0.06,
      phase_GMT: 170.4,
      phase_local: 103.4,
      speed: 13.398661
    },
    {
      number: 27,
      name: "T2",
      description: "Larger solar elliptic constituent",
      amplitude: 0.13,
      phase_GMT: 126.5,
      phase_local: 336.7,
      speed: 29.958933
    },
    {
      number: 28,
      name: "R2",
      description: "Smaller solar elliptic constituent",
      amplitude: 0.0,
      phase_GMT: 0.0,
      phase_local: 0.0,
      speed: 30.041067
    },
    {
      number: 29,
      name: "2Q1",
      description: "Larger elliptic diurnal",
      amplitude: 0.01,
      phase_GMT: 165.0,
      phase_local: 100.7,
      speed: 12.854286
    },
    {
      number: 30,
      name: "P1",
      description: "Solar diurnal constituent",
      amplitude: 0.15,
      phase_GMT: 199.4,
      phase_local: 124.6,
      speed: 14.958931
    },
    {
      number: 31,
      name: "2SM2",
      description: "Shallow water semidiurnal constituent",
      amplitude: 0.02,
      phase_GMT: 48.5,
      phase_local: 253.4,
      speed: 31.015896
    },
    {
      number: 32,
      name: "M3",
      description: "Lunar terdiurnal constituent",
      amplitude: 0.0,
      phase_GMT: 0.0,
      phase_local: 0.0,
      speed: 43.47616
    },
    {
      number: 33,
      name: "L2",
      description: "Smaller lunar elliptic semidiurnal constituent",
      amplitude: 0.74,
      phase_GMT: 145.2,
      phase_local: 357.5,
      speed: 29.528479
    },
    {
      number: 34,
      name: "2MK3",
      description: "Shallow water terdiurnal constituent",
      amplitude: 0.0,
      phase_GMT: 0.0,
      phase_local: 0.0,
      speed: 42.92714
    },
    {
      number: 35,
      name: "K2",
      description: "Lunisolar semidiurnal constituent",
      amplitude: 0.41,
      phase_GMT: 148.5,
      phase_local: 358.0,
      speed: 30.082138
    },
    {
      number: 36,
      name: "M8",
      description: "Shallow water eighth diurnal constituent",
      amplitude: 0.06,
      phase_GMT: 294.0,
      phase_local: 74.3,
      speed: 115.93642
    },
    {
      number: 37,
      name: "MS4",
      description: "Shallow water quarter diurnal constituent",
      amplitude: 0.08,
      phase_GMT: 162.0,
      phase_local: 227.0,
      speed: 58.984104
    }
  ],
  self: "https://api.tidesandcurrents.noaa.gov/mdapi/prod/webapi/stations/8410834/harcon.json"
}

// Record the initial time so the delta can be calculated later
const timeSubtract = new Date().getTime()
// This is how much to scale by
const unit = 10
const canvasSize = [500, 500]
// The amplitude indicators on the harmonics are called beads
const beadSize = 5
const speed = 1
const frameRate = 60
let axesStrokeColor = 'rgba(0, 0, 0, 1)'
let featureFillColor = 'rgba(0, 128, 255, 0)'
let featureStrokeColor = 'rgba(0, 128, 255, 1)'
// How smooth the tide chart curves should be
const wavePrecision = .25

const numOfConstituents = 5
let constituents = harcon.HarmonicConstituents
constituents.sort((a, b) => b.amplitude - a.amplitude)
constituents = constituents.slice(0, numOfConstituents)

let timeSeriesChords = []

// declare a lot of variables that should not be redeclared each time
let canvas, ctx, height, width, xAxis, yAxis,
    x, y, nextXCenter, nextYCenter, timeSeriesLength;

const emptyFunction = () => {
}

const init = () => {
  // this may change, will revisit
  canvas = document.getElementById("canvas");

  canvas.width = 500;
  canvas.height = 500;

  ctx = canvas.getContext("2d");
  ctx.lineJoin = 'round';

  height = canvas.height;
  width = canvas.width;

  xAxis = Math.floor(height/2);
  yAxis = Math.floor(width/4);

  timeSeriesLength = ((width - yAxis) / wavePrecision)

  populateTimeSeries(timeSeriesLength, emptyFunction)

  // Tracking the center of the current constituent is important

  ctx.save();

  window.requestAnimationFrame(draw);
}

const draw = () => {

  const time = new Date()

  nextXCenter = yAxis
  nextYCenter = xAxis

  ctx.clearRect(0, 0, width, height);

  // Draw the axes in their own path
  ctx.strokeStyle = axesStrokeColor;
  ctx.beginPath();
  drawAxes();

  // Set styles for animated graphics
  ctx.save();
  ctx.strokeStyle = featureStrokeColor;
  ctx.fillStyle = featureFillColor;
  ctx.lineWidth = 1;



  // Update the time and draw again
  draw.t = (time - timeSubtract) / (100000 / speed);
  runThroughConstituents(draw.t * Math.PI, drawEpicycles)
  drawTideChart();
  drawArrow();
  ctx.restore();

  setTimeout(draw, (1000 / frameRate));
}

const runThroughConstituents = (time, drawFunction) => {
  constituents.forEach((constituent, idx) => {
    const radius = Math.floor(constituent.amplitude * unit)
    drawFunction(radius)
    getLocationOnCircle(time, radius, constituent)
    if (idx == (constituents.length - 1)) {
      timeSeriesChords = [...timeSeriesChords, nextYCenter].slice(-timeSeriesLength)
    }
  })
}

const getRadians = (angle) => {
  return (angle * (Math.PI / 180))
}

const getLocationOnCircle = (time, radius, constituent) => {
  let nextCenters = getPhasedXY(time, radius, constituent)
  nextXCenter = nextCenters[0]
  nextYCenter = nextCenters[1]
}

const getPhasedXY = (time, radius, constituent) => {
  const { phase_GMT, speed} = constituent
  let phase = phase_GMT
  let phaseX = nextXCenter + (radius * Math.sin(((time + getRadians(phase)) * speed)))
  let phaseY = nextYCenter + (radius * Math.cos(((time + getRadians(phase)) * speed)))
  return [phaseX, phaseY]
}

const populateTimeSeries = (timeSeriesLength) => {
  for (let i = 0; i < timeSeriesLength; i++) {
    runThroughConstituents(i, emptyFunction)
    timeSeriesChords.push(nextYCenter)
  }
}

// Drawing functions
const drawArrow = () => {

  ctx.beginPath()
  ctx.setLineDash([5, 10]);
  ctx.moveTo(yAxis, nextYCenter)
  ctx.lineTo(nextXCenter, nextYCenter)
  ctx.stroke()

}

const drawEpicycles = (radius) => {
  ctx.beginPath()
  ctx.arc(nextXCenter, nextYCenter, radius, 0, 2*Math.PI, false);
  ctx.fill();
  ctx.stroke();
}



function drawTideChart() {

  ctx.beginPath();
  ctx.moveTo(width, timeSeriesChords[0]);
  timeSeriesChords.slice(1).forEach((yCoordinate, idx) => {
    ctx.lineTo((width - ((idx + 1) * wavePrecision)), yCoordinate);
  })

  ctx.stroke();
}


const drawAxes = () => {
  // Draw X and Y axes
  ctx.strokeStyle = axesStrokeColor;
  ctx.moveTo(0, xAxis);
  ctx.lineTo(width, xAxis);
  ctx.moveTo(yAxis, 0);
  ctx.lineTo(yAxis, height);
  ctx.stroke();
}

init()
